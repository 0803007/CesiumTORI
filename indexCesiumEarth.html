<!DOCTYPE html> 
<html lang="en">
<head>
	<link href="DB/Images/favicon.ico" rel="SHORTCUT ICON" id="css">
	<!-- Use correct character set. -->
	<meta charset="utf-8">
	<!-- Tell IE to use the latest, best version. -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<title>ToriMIS</title>
	<script src="../js/d3.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>  <!--這包很大,未來要下載回來  -->
	<!-- <script src="../../js/ajax_select.js" type="text/javascript" ></script> -->
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<script src="Build/Cesium/Cesium.js"></script>
	<script src="../js/WebGLGlobeDataSource.js"></script>
	<script src="DB/Images/Site.js" charset="big5"></script>
	<style>
		@import url(Apps/Sandcastle/templates/bucket.css);
		@import url(Build/Cesium/Widgets/widgets.css);
		html, body, #cesiumContainer {
			width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;  
		}
		.toolbar-left {
			display: block;
			position: absolute;
			top: 5px;
			left: 5px;
		}
		.loading-mask {
			display: block;
			position: absolute;
			z-index: 2;
			top: 50%;
		    left: 45%;
		}
		.logo {	
			position: absolute;
			z-index: 2;
			bottom: 7%;
			right: 3%;
		}
		.ui-datepicker {
		    background: #333;
		    border: 1px solid #555;
		    color: #EEE;
		}
		.input[type=range] {
			webkit-appearance: none;
			width: 100%;
			border-radius: 8px;
			height: 7px;
			border: 1px solid #bdc3c7;
			background-color: #fff; 
		}
	</style>
	<div class="loading-mask" id="loadingIMG" style="display:none"><span style="font-size:3em;">Loading .....</span></div>
	<div id="cesiumContainer"></div>
	<div id="mousePosition">Loading...</div>
	<div class="toolbar-left">
		<p id="textPosition">世界座標</p> 
		<input type="checkbox" id="cbox1" value="second_checkbox" onchange="showRotation(this.checked)" checked = "true"> <label>Rotation</label>  
		<input type="checkbox" id="cbox2" value="second_checkbox" onchange="showLogo(this.checked)" checked = "true"> <label>Logo</label>  
		<input type="checkbox" id="cbox3" value="second_checkbox" onchange="showTerrain(this.checked)" > <label>Terrain</label> 
		<input type="checkbox" id="cbox4" value="second_checkbox" onchange="showLight(this.checked)" checked = "true"> <label>Sun</label> 
		<input type="checkbox" id="cbox5" value="second_checkbox" onchange="showTOROSStation(this.checked)" checked = "true" > <label>TOROS Station</label><br>
		<select id="typing" onchange="showTyping(this.value)">
			<option>請選擇船種</option>
			<option>RR</option>
			<option>OR1</option>
			<option>OR2</option>
			<option>OR3</option>
			<option>OR5</option>
			<option>ORV</option>
			<option>KM</option>
			<option>MV</option>
		</select>
		<select id="claassing" onchange="">
			<option>請選擇航次</option>
		</select>
		<button onclick="showClassingFromSQL(document.getElementById('claassing').value)">讀取船次</button>
		<button onclick="deleteLine()">刪掉船次</button><br>
		<button onclick="loadClassingJSON()" style="display:none">讀取JSON船次(測試按鈕)</button>
		
		<select id="torosMonth" onchange="showTorosDateFromSQL()">
			<option>請選擇月</option>
			<option>201611</option>
			<option>201610</option>
			<option>201609</option>
<!-- 		<option>201608</option>
			<option>201607</option>
			<option>201606</option>
			<option>201605</option>
			<option>201604</option>
			<option>201603</option>
			<option>201602</option>
			<option>201601</option>
			<option>201512</option>
			<option>201511</option>
			<option>201510</option>
			<option>201509</option>
			<option>201508</option>
			<option>201507</option>
			<option>201506</option>
			<option>201505</option>
			<option>201504</option>
			<option>201503</option>
			<option>201502</option>
			<option>201501</option> -->
		</select>
		<select id="torosDate" onchange="">
			<option>請選擇日</option>
		</select>
		<button onclick="loadTorosJSONFromSQL()">讀取TOROS</button>
		<button onclick="deleteToros()">刪除TOROS</button><br>
		<select id="chlorophyll" >
			<option>請選擇時間</option>
			<option>2016年12月~2017年2月</option>
			<option>2016年9月~2016年11月</option>
			<option>2016年6月~2016年8月</option>
			<option>2016年3月~2016年5月</option>
			<option>2015年12月~2016月2月</option>
			<option>2015年9月~2015月11月</option>
			<option>2015年12月~2016月2月</option>
		</select>
		<button onclick="loadChlorophyll()">讀取葉綠素</button>
		<button onclick="deleteChlorophyll()">刪除葉綠素</button><br>
		<select id="waterTemperature">
			<option>請選擇時間</option>
			<option>2016年12月~2017年2月</option>
			<option>2016年9月~2016年11月</option>
			<option>2016年6月~2016年8月</option>
			<option>2016年3月~2016年5月</option>
			<option>2015年12月~2016月2月</option>
			<option>2015年9月~2015月11月</option>
			<option>2015年12月~2016月2月</option>
		</select>
		<button onclick="loadWaterTemperature()">讀取水溫</button>
		<button onclick="deleteWaterTemperature()">刪除水溫</button><br>
		<button onclick="loadPM25()">PM2.5(測試)</button>
		<button onclick="deletePM25()">刪除PM2.5(測試)</button><br>
		<input type="range" id="range" min="0" max="1" step="0.05" value="0.6"><br>
		<canvas width="380" height="55" id="cv"></canvas><br>
	</div>

	<div class="logo">
		<!-- <canvas width="380" height="55" id="logo"></canvas> --> 
		<a href="http://www.tori.org.tw/"><img id="logo1" src="DB/Images/foot_logo.png"></a>
		<a href="http://www.tori.org.tw/"><img id="logo2" src="DB/Images/LOGO.png"></a>
	</div>
	<div id="dialog" title="Basic dialog" >
	    Date:<input type="text" id="datepicker">
		Select a speed:
		<select name="speed" id="selectWeather">		
			<option selected="selected">Temperature</option>
			<option>Humidity</option>
			<option>Pressure</option>
		</select>
		<button class="ui-button ui-widget ui-corner-all" onclick="showWeatherFromSQL()">Set</button><br>
		<div id="highcharts" title="Basic dialog"><br>
		<p>This is the default dialog which is useful for displaying information. The dialog window can be moved, resized and closed with the 'x' icon.</p>
	</div>
	<!-- <div id="container" style="min-width: 610px; height: 800px; margin: 0 auto"></div> -->
</head>
<body>

<script>
    /*
	var v  = document.getElementById('cv'),
    ctx = cv.getContext('2d');

	for(var i = 0; i <= 255; i++) {
		ctx.beginPath();
		
		var color = 'rgb(100, ' + i + ', ' + i + ')';
		ctx.fillStyle = color;
		
		ctx.fillRect(i * 2, 0, 2, 50);
	}

	cv.onclick = function(e) {
		var x = e.offsetX,
			y = e.offsetY,
			p = ctx.getImageData(x, y, 1, 1),
			x = p.data;
		
		alert('Color: rgb(' + x[0] + ', ' + x[1] + ', ' + x[2] + ')');
	};*/

	// Global Var
	var block = null;
	var entityLineClassing = null;
	var entityBoat = null
	var entityArrowToros = []; //array
	var entityPM25 = [];//array
	var imageLayerChlorophyll = null;
	var imageLayerWaterTemperature = null;
	var bAutoRotation = true;
	var cartographic = new Cesium.Cartographic();
	var modelBoat = null;   //test Model
	var bluePin1 = null;
	var bluePin2 = null;
	var bluePin3 = null;
	var bluePin4 = null;
	var posWeather = "NAWN";
   
	/*var widget = new Cesium.CesiumWidget('cesiumContainer');
	viewer.scene.debugShowFramesPerSecond = true;
	var layers = widget.imageryLayers;
	
	var glacierData = layers.addImageryProvider(new Cesium.SingleTileImageryProvider({
		url: '../../Images/V20162452016274.L3m_MO_SNPP_CHL_chlor_a_4km.nc.png'
		}));

	glacierData.alpha = 0.2;*/
	
	//Init Cesium	
	Cesium.BingMapsApi.defaultKey = "y10PwCCQ3kETfTfZrpia~WuBQuZSyqg3XTS3LFnjonw~AsJ0CEBEcA2bth5UvagyEvpWaC1Ww71fVt26OaFrWlS7ZSzrnkgBOUFmA1hVweMG";//license
    var viewer = new Cesium.Viewer('cesiumContainer', { infoBox : true });
	var pinBuilder = new Cesium.PinBuilder();
	var layers = viewer.scene.imageryLayers;
	
	//set iframe
	viewer.infoBox.frame.sandbox = "allow-same-origin allow-top-navigation allow-pointer-lock allow-popups allow-forms allow-scripts";
	
	//init sun light
	viewer.scene.debugShowFramesPerSecond = true;
	viewer.scene.globe.enableLighting = true;
	viewer.scene.sun.glowFactor = 10; 
	
	//var credit = new Cesium.Credit('Title', 'favicon.ico', 'http://www.cesiumjs.org');
	//viewer.scene.frameState.creditDisplay.addDefaultCredit(credit)
	
	//Use STK World , will reduce FPS
	/*
	viewer.terrainProvider = new Cesium.CesiumTerrainProvider({
		url : 'https://assets.agi.com/stk-terrain/world',
		requestWaterMask : true,
		requestVertexNormals : true
	});*/
	
	// Init ScreenSpaceEventHandler
	var screenSpaceEventHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
	var cartesian = new Cesium.Cartesian3();
	var rectangleCoordinates = new Cesium.Rectangle();
	var scratchCartographic = new Cesium.Cartographic();
	var center = new Cesium.Cartographic();
	var firstPoint = new Cesium.Cartographic();
	var firstPointSet = false;
	var mouseDown = false;

	//Default auto rotation
	spinGlobe( 0.2  ); //default 
	function spinGlobe( dynamicRate ){
		 var previousTime = Date.now();

		 viewer.clock.onTick.addEventListener(function(clock) {
			if (bAutoRotation){
				var spinRate = dynamicRate;
				var currentTime = Date.now();
				var delta = ( currentTime - previousTime ) / 10000;
				previousTime = currentTime;
				viewer.scene.camera.rotate(Cesium.Cartesian3.UNIT_Z, -spinRate * delta);
			}
		});
	}
	
	function showRotation(checked){
		bAutoRotation = checked;
	}
	
	function showLogo(checked){
		if (checked){
			document.getElementById('logo1').style = "display:visible";
			document.getElementById('logo2').style = "display:visible";	
			
			document.getElementsByClassName("cesium-widget-credits")[0].style = "display:visible";
								
		}else{
			document.getElementById('logo1').style = "display:none";
			document.getElementById('logo2').style = "display:none";
			
			document.getElementsByClassName("cesium-widget-credits")[0].style = "display:none";
		}
	}
	
	function showTerrain(checked){
		if (checked){
			viewer.terrainProvider = new Cesium.CesiumTerrainProvider({
				url : 'https://assets.agi.com/stk-terrain/world',
				requestWaterMask : true,
				requestVertexNormals : true
			});
		}else{
			viewer.terrainProvider =  new Cesium.EllipsoidTerrainProvider({});

		}
	}
	
	function showLight(checked){
		viewer.scene.globe.enableLighting = checked;
	}
	
	function showTOROSStation(check){
		if (check ){
			bluePin1.show = true;
			bluePin2.show = true;
			bluePin3.show = true;
			bluePin4.show = true;
		}else{
			bluePin1.show = false;
			bluePin2.show = false;
			bluePin3.show = false;
			bluePin4.show = false;
		}
	}
	
	//Get & Show Mouse Position
	viewer.scene.canvas.addEventListener('mousemove', function (e) {
		//var entity = viewer.entities.getById('alo');
		var ellipsoid = viewer.scene.globe.ellipsoid;
		// Mouse over the globe to see the cartographic position
		var cartesian = viewer.camera.pickEllipsoid(new Cesium.Cartesian2(e.clientX,e.clientY), ellipsoid);

		if (cartesian) {
		    bAutoRotation = false;
			cartographic = ellipsoid.cartesianToCartographic(cartesian);
			var longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(5);
			var latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(5);
			
			document.getElementById("textPosition").innerHTML = "Longitude:" + longitudeString  + " , Latitude:" + latitudeString;
			//entity.position = cartesian;
			//entity.label.show = true;
			//entity.label.text = '(' + longitudeString + ', ' + latitudeString + ')';
		} else {
			//entity.label.show = false;
		}
			
	});
	
	//Disable some unneeded camera operations
	//viewer.scene.screenSpaceCameraController.enableTranslate = false;
	//viewer.scene.screenSpaceCameraController.enableTilt = false;
	viewer.scene.screenSpaceCameraController.enableLook = false;
	//viewer.scene.screenSpaceCameraController.enableCollisionDetection = false;
	
	//Draw the selector while the user drags the mouse while holding shift
	screenSpaceEventHandler.setInputAction(function drawSelector(movement) 
	{
		if (!mouseDown) {
			return;
		}

		cartesian = viewer.camera.pickEllipsoid(movement.endPosition, viewer.scene.globe.ellipsoid, cartesian);

		if (cartesian) {
			//mouse cartographic
			var tempCartographic = Cesium.Cartographic.fromCartesian(cartesian, Cesium.Ellipsoid.WGS84, tempCartographic);

			if (!firstPointSet) {
			  Cesium.Cartographic.clone(tempCartographic, firstPoint);
			  firstPointSet = true;
			}
			else {
			  rectangleCoordinates.east = Math.max(tempCartographic.longitude, firstPoint.longitude);
			  rectangleCoordinates.west = Math.min(tempCartographic.longitude, firstPoint.longitude);
			  rectangleCoordinates.north = Math.max(tempCartographic.latitude, firstPoint.latitude);
			  rectangleCoordinates.south = Math.min(tempCartographic.latitude, firstPoint.latitude);
			  selector.show = true;
			}
		}
	}, Cesium.ScreenSpaceEventType.MOUSE_MOVE, Cesium.KeyboardEventModifier.SHIFT);

	var getSelectorLocation = new Cesium.CallbackProperty(function getSelectorLocation(time, result) {
		return Cesium.Rectangle.clone(rectangleCoordinates, result);
	}, false);

	screenSpaceEventHandler.setInputAction(function startClickShift() {
		mouseDown = true;
		selector.rectangle.coordinates = getSelectorLocation;
	}, Cesium.ScreenSpaceEventType.LEFT_DOWN, Cesium.KeyboardEventModifier.SHIFT);

	screenSpaceEventHandler.setInputAction(function endClickShift() {
		mouseDown = false;
		firstPointSet = false;
		selector.rectangle.coordinates = rectangleCoordinates;
	}, Cesium.ScreenSpaceEventType.LEFT_UP, Cesium.KeyboardEventModifier.SHIFT);
	
	//Hide the selector by clicking anywhere
	screenSpaceEventHandler.setInputAction(function hideSelector() {
		selector.show = false;
	}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
	
	selector = viewer.entities.add({
		selectable: false,
		show: false,
		rectangle: {
			fill : false,
			outline : true,
			outlineColor : Cesium.Color.WHITE,
			outlineWidth : 4,
			stRotation : Cesium.Math.toRadians(45),
			coordinates: getSelectorLocation
			//material: Cesium.Color.RED.withAlpha(0.5)
		}
	});
	
	//Get & Show Double Click
	viewer.scene.canvas.addEventListener('dblclick', function (e) {
		//var entity = viewer.entities.getById('alo');
		var ellipsoid = viewer.scene.globe.ellipsoid;
		// Mouse over the globe to see the cartographic position
		var cartesian = viewer.camera.pickEllipsoid(new Cesium.Cartesian2(e.clientX,e.clientY), ellipsoid);

		if (cartesian) {
		    bAutoRotation = false;
			var cartographic = ellipsoid.cartesianToCartographic(cartesian);
			var longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(5);
			var latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(5);
			
			//Add question Pin
			var questionPin = viewer.entities.add({
				name : 'Question mark',
				position : Cesium.Cartesian3.fromDegrees(longitudeString, latitudeString),
				billboard : {
					image : pinBuilder.fromText('??', Cesium.Color.BLACK, 48).toDataURL(),
					verticalOrigin : Cesium.VerticalOrigin.BOTTOM
				}
			});

		} else {
			//entity.label.show = false;
		}
	});
	
	/*
	var redLine = viewer.entities.add({
    name : 'Red line on the surface',
    polyline : {
				positions : Cesium.Cartesian3.fromDegreesArray([
																	0.0, 0.0,
																	10.0, 0.0,
																	0.0, 20.0,				
																]),
        width : 5,
		outline : true,
        material : Cesium.Color.RED
    }});*/
	/*
	var logoBillboed = viewer.entities.add({
			position : Cesium.Cartesian3.fromDegrees(120.0,20.0),
			billboard : {
			image : '../../Images/LOGO.png'
			}
	});*/
    //console.log(logoBillboed);
	function showTorosDateFromSQL(){
		$.ajax({
				url: "DB/TOROS/getDate.php",
				data: "month=" + document.getElementById('torosMonth').value,
				type:"POST",
				dataType:"JSON",

				success: function(data){
				    // Clear option
					torosDate.options.length = 1;
					//Add soption
					var len = data.length;
					console.log(data[0]);
					
					for (i=0;i<len;i=i+1 ){
						torosDate.options[i+1] = new Option(data[i],data[i]);
					}
				},

				error:   function(jqXHR, textStatus, errorThrown){ 
					//document.getElementById("message").innerHTML=errorThrown; 
				}
			});
	}	

	function showTyping(str){
		$.ajax({
				url: "DB/CruiseDB/getClassing.php",
				data: "&tname="+str,
				type:"POST",
				dataType:"JSON",

				success: function(data){
				    // Clear option
					claassing.options.length = 1;
					//Add soption
					var len = data.length;
					console.log(str);
					console.log(data[0]);
					
					for (i=0;i<len;i=i+1 ){
						claassing.options[i+1] = new Option(data[i],data[i]);
					}
				},

				error:   function(jqXHR, textStatus, errorThrown){ 
					document.getElementById("message").innerHTML=errorThrown; 
				}
			});
	}
	function showClassingFromSQL(str){
		//console.log(str);
		$.ajax({
			url: "DB/CruiseDB/getData.php",
			data: "&tname="+str,
			global: true,
			type:"POST",
			dataType:"JSON",

			success: function(data){
			    if (entityLineClassing != null)
					deleteLine();
					//viewer.entities.remove(entityLineClassing);
				
				//console.log(d);
				console.log(data);
				//document.getElementById("message").innerHTML=message;
				
				//Add Line
				var path = [];
				var len = data.length;
				
				//var cook = {"type": "LineString", "coordinates": [[120,22]] };
				for (i=0;i<len;i=i+1 ){
					//var c = [json[i].Latitude , json[i].Longitude];
					//cook.coordinates.push(c);
					path.push(data[i].Longitude);
					path.push(data[i].Latitude);	
				}
				entityLineClassing = viewer.entities.add({
					name : 'Red line on the surface',
					polyline : {
						positions : Cesium.Cartesian3.fromDegreesArray(path),
						width : 1,
						material : Cesium.Color.GREEN
				}});

				viewer.flyTo(entityLineClassing);
				
				//Set bounds of our simulation time
				var start = new Cesium.JulianDate();
				var stop = Cesium.JulianDate.addSeconds(start, data.length, new Cesium.JulianDate());
				//Animation
				var positions = new Cesium.SampledPositionProperty();
				var positionsSmooth = new Cesium.SampledPositionProperty();
				var path3D = [];
				var len = data.length;
				for (i=0;i<len;i++ ){
					var time = new Cesium.JulianDate.addSeconds(start, i*1, new Cesium.JulianDate());
					var position = new Cesium.Cartesian3.fromDegrees(data[i].Longitude,data[i].Latitude, 1);
					positions.addSample(time, position);	
					
					//console.log(data[i].Longitude);
					//Smooth
					if (i<11 || i>len-10){
						positionsSmooth.addSample(time, position);
					}else{						
						var count = 0;
						var count2 = 0;
						count = (parseFloat(data[i-10].Longitude)+parseFloat(data[i-9].Longitude)+parseFloat(data[i-8].Longitude)+parseFloat(data[i-7].Longitude)+parseFloat(data[i-6].Longitude)
									+parseFloat(data[i-5].Longitude)+parseFloat(data[i-4].Longitude)+parseFloat(data[i-3].Longitude)+parseFloat(data[i-2].Longitude)+parseFloat(data[i-1].Longitude)
									+parseFloat(data[i].Longitude)+parseFloat(data[i+1].Longitude)+parseFloat(data[i+2].Longitude)+parseFloat(data[i+3].Longitude)+parseFloat(data[i+4].Longitude)
									+parseFloat(data[i+5].Longitude)+parseFloat(data[i+6].Longitude)+parseFloat(data[i+7].Longitude)+parseFloat(data[i+8].Longitude)+parseFloat(data[i+9].Longitude))/20;
								
						count2 = (parseFloat(data[i-10].Latitude)+parseFloat(data[i-9].Latitude)+parseFloat(data[i-8].Latitude)+parseFloat(data[i-7].Latitude)+parseFloat(data[i-6].Latitude)
									+parseFloat(data[i-5].Latitude)+parseFloat(data[i-4].Latitude)+parseFloat(data[i-3].Latitude)+parseFloat(data[i-2].Latitude)+parseFloat(data[i-1].Latitude)
									+parseFloat(data[i].Latitude)+parseFloat(data[i+1].Latitude)+parseFloat(data[i+2].Latitude)+parseFloat(data[i+3].Latitude)+parseFloat(data[i+4].Latitude)
									+parseFloat(data[i+5].Latitude)+parseFloat(data[i+6].Latitude)+parseFloat(data[i+7].Latitude)+parseFloat(data[i+8].Latitude)+parseFloat(data[i+9].Latitude))/20;
							
						position = new Cesium.Cartesian3.fromDegrees(count,count2,10);
						positionsSmooth.addSample(time, position);	
					}		
				}
		
				//Make sure viewer is at the desired time.
				viewer.clock.startTime = start.clone();
				viewer.clock.stopTime = stop.clone();
				viewer.clock.currentTime = start.clone();
				viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; //Loop at the end
				viewer.clock.multiplier = 10;
				
				//Set timeline to simulation bounds
				//viewer.timeline.zoomTo(start, stop);
								
				//Actually create the entity
				entityBoat = viewer.entities.add({
				    name: 'test',
					//Set the entity availability to the same interval as the simulation time.
					
					availability : new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({
						start : start,
						stop : stop
						 
					})]),
					//Use our computed positions
					position : positions,
					//position : 
						//Cesium.Cartesian3.fromDegrees(123.0744619, 20.0503706, 10),
					
					//Automatically compute orientation based on position movement.
					orientation : new Cesium.VelocityOrientationProperty(positionsSmooth),
					//Load the Cesium plane model to represent the entity
					model : {
						uri : "DB/3DModel/3d-model.gltf",
						scale : 5.0,
						minimumPixelSize : 128
					}
					/*
					//Show the path as a pink line sampled in 1 second increments.
					path : {
						resolution : 1,
						material : new Cesium.PolylineGlowMaterialProperty({
							glowPower : 0.1,
							color : Cesium.Color.YELLOW
						}),
						width : 5
					}*/
				});
				//viewer.trackEntity = entityBoat;
				entityBoat.position.setInterpolationOptions({

						interpolationDegree : 5,
						interpolationAlgorithm : Cesium.LagrangePolynomialApproximation 
				});

				//if (document.readyState=="complete")
				//	alert('Good');
				
				/*
				console.log(path3D);
				var orientation = new Cesium.VelocityOrientationProperty(path3D,true);
				console.log(orientation);
				
				
				var czml = [{
					"id" : "document",
					"name" : "CZML Model",
					"version" : "1.0",
					"clock": {
						"interval": "2012-08-04T10:00:00Z/2012-08-04T15:00:00Z",
						"currentTime": "2012-08-04T10:00:00Z",
						"multiplier": 10
					}
					}, {
						"id" : "aircraft model",
						"name" : "Cesium Air",
						"position" : {
						    "epoch" : "2012-08-04T10:00:00Z",
							"cartographicDegrees" : path3D
						},
						"model": {
							"gltf" : "DB/3DModel/3d-model.gltf",
							"scale" : 5000.0,
							"minimumPixelSize": 128
						},
						"orientation":{
							"unitQuaternion":orientation
						}
				}];
				var promise = viewer.dataSources.add(Cesium.CzmlDataSource.load(czml));*/
			},
			beforeSend:function(){
                $('#loadingIMG').show();
			},
			complete:function(){
				$('#loadingIMG').hide();
			},
			error:   function(jqXHR, textStatus, errorThrown){ 
				//document.getElementById("message").innerHTML=errorThrown; 
			}

		});
	
	}
	$(function() {
			$( "#datepicker" ).datepicker({ dateFormat: 'yymm',defaultDate: new Date(2016, 10, 1)});
	});
	function showWeatherFromSQL(){		
		var weather = document.getElementById('selectWeather').value;
		var date = document.getElementById('datepicker').value;
		var pos = posWeather;
		console.log(weather);
		console.log(date);

		$.ajax({
			url: "DB/WeatherStation/getWeather.php",
			data:"weather="+ weather + "&date=" + date + "&pos=" + pos,
			type:"POST",
			dataType:"JSON",

			success: function(data){
				//Add soption
				var len = data.length;
				//Add Line
				var array = [];
				var len = data.length;
				
				//var cook = {"type": "LineString", "coordinates": [[120,22]] };
				for (i=0;i<len;i=i+1 ){
					//var c = [json[i].Latitude , json[i].Longitude];
					//cook.coordinates.push(c);
					array.push(parseFloat(data[i].key));	
				}
				setCharts(posWeather,array,weather);
			},

			error:   function(jqXHR, textStatus, errorThrown){ 
				alert("這個月沒有資料");
				console.log("error");
			}
		});
	}
	function setCharts(pos,data,weather){
		Highcharts.chart('highcharts', {

			title: {
				text: pos,
				x: -20 //center
			},
			subtitle: {
				text: 'Source: www.tori.narl.org.tw',
				x: -20
			},
			xAxis: {
				//categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
				//	'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
			},
			yAxis: {
				title: {
					text: weather
				},
				plotLines: [{
					value: 0,
					width: 1,
					color: '#808080'
				}]
			},
			tooltip: {
				valueSuffix: ''
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'middle',
				borderWidth: 0
			},
			series: [{
				name: pos,
				data: data
			}]
		});
	}
	
	function deleteLine() {
		viewer.entities.remove(entityLineClassing);
		viewer.entities.remove(entityBoat);
		
		entityLineClassing = null;
	}

	// Loading  Classing JSON File
	function loadClassingJSON() {
		//Draw Line
		Cesium.loadJson('../../data/OR1-1144.json').then(function(json) {
			// Do something with the JSON object
			var test = [];
			var len = json.length;
			console.log(len);
			//var cook = {"type": "LineString", "coordinates": [[120,22]] };
			for (i=0;i<len;i=i+1){
				//var c = [json[i].Latitude , json[i].Longitude];
				//cook.coordinates.push(c);
				test.push(json[i].Latitude);
				test.push(json[i].Longitude);

			}
			console.log(test);
			var jsonLine = viewer.entities.add({
				name : 'Red line on the surface',
				polyline : {
					positions : Cesium.Cartesian3.fromDegreesArray(test),
					width : 2,
					material : Cesium.Color.RED}
			});
			viewer.flyTo(jsonLine);

		}).otherwise(function(error) {
			// an error occurred
		});
	}

	range.onchange = function(){
	    if (imageLayerChlorophyll!=null)
			imageLayerChlorophyll.alpha = range.value;
			
		if (imageLayerWaterTemperature!=null)
			imageLayerWaterTemperature.alpha = range.value;
	};
	/*
	Sandcastle.addDefaultToolbarButton('Remove', function() {
		viewer.entities.remove(redLine);
		viewer.zoomTo(viewer.entities, new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90)));
	});
	Sandcastle.addToolbarButton('Basic styling', function() {
		viewer.zoomTo(viewer.entities, new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90)));
	});*/

	//--------------test button--------------
	//Load TOROS Json file
	// Loading  Classing JSON File
	function loadTorosJSON() {
		Cesium.loadJson('../data/toros.json').then(function(jsonData) {
		   
			if (entityArrowToros.length != 0)
				deleteToros();
			
			// Do something with the JSON object
			var len = jsonData.length;
			//draw flow
			for (var i = 0; i < len; i++) {
				var x,y;
				var u,v;
				x = jsonData[i].Longitude;
				y = jsonData[i].Latitude;
				u = jsonData[i].Ucomp;
				v = jsonData[i].Vcomp;
				V = jsonData[i].Velocity
			
				var arrowToros = viewer.entities.add({
					name : 'Red straight arrow at height',
					polyline : {
						positions : Cesium.Cartesian3.fromDegreesArrayHeights([x, y, 10,
																			   (x+u/300), (y+v/300), 10]),
						width : 5,
						followSurface : false,
						//material : new Cesium.PolylineArrowMaterialProperty(new Cesium.Color(V/100,1-V/100,0,1))
						material : new Cesium.PolylineArrowMaterialProperty(Cesium.Color.RED)
					}
				});
				entityArrowToros.push(arrowToros);
			}
			/*
			//any JSON data formatted for WebGL Globe.
			var dataSource = new WebGLGlobeDataSource();
			dataSource.loadUrl('../../data/toros.json');

			//viewer.clock.shouldAnimate = false;
			viewer.dataSources.add(dataSource);*/
			
			viewer.flyTo(viewer.entities);
			
		}).otherwise(function(error) {
			// an error occurred
		});
	}
	function loadTorosJSONFromSQL() {
		month = document.getElementById('torosMonth').value;
		date = document.getElementById('torosDate').value;
		console.log(month);
		console.log(date);
		$.ajax({
			url: "DB/TOROS/getArrow.php",
			data:"month="+ month + "&date=" + date,
			type:"POST",
			dataType:"JSON",

			success: function(data){
				if (entityArrowToros.length != 0)
					deleteToros();
					
				//Add soption
				var len = data.length;
				console.log(len);
				console.log(data[0]);
				
				for (i=0;i<len;i++){
					var x,y;
					var u,v;
					x = data[i].Longitude;
					y = data[i].Latitude;
					u = data[i].Ucomp;
					v = data[i].Vcomp;
					V = data[i].Velocity;
					
					var arrowToros = viewer.entities.add({
						name : 'Red straight arrow at height',
						polyline : {
							positions : Cesium.Cartesian3.fromDegreesArrayHeights([(x-(u/500.000)), (y-(v/500.000)),10   //Some Problem
																					,x, y, 10]),
							width : 5,
							followSurface : false,
							//material : new Cesium.PolylineArrowMaterialProperty(new Cesium.Color(V/100,1-V/100,0,1))
							material : new Cesium.PolylineArrowMaterialProperty(Cesium.Color.RED)
						}
					});
					entityArrowToros.push(arrowToros);
					//if (i == 10)
					//	break;
				}
				viewer.flyTo(viewer.entities);
			},
			beforeSend:function(){
				$('#loadingIMG').show();
			},
			complete:function(){
				$('#loadingIMG').hide();
			},
			error: function(jqXHR, textStatus, errorThrown){ 
				//document.getElementById("message").innerHTML=errorThrown; 
			}
			
		});
	
	}
	function deleteToros() {	
		if (entityArrowToros.length == 0)
			return;
			
	    for (var i=0;i<entityArrowToros.length;i++){
			viewer.entities.remove(entityArrowToros[i]);
		}
			
		entityArrowToros = [];
	}
	function loadChlorophyll(){
	    if (imageLayerWaterTemperature!=null)
			deleteWaterTemperature();
			
		if (imageLayerChlorophyll!=null)
			deleteChlorophyll();
	
	    //Loading select name
	    var nameSelect = document.getElementById('chlorophyll').value;
	
	    //Loading URL image
		imageLayerChlorophyll = layers.addImageryProvider(new Cesium.SingleTileImageryProvider({
			url: 'DB/Images/Chlorophyll/' + nameSelect + '.png'
		}));
		imageLayerChlorophyll.alpha = range.value;   
		
		//Show the colorbar
		var canvas = document.getElementById('cv');
		var context = canvas.getContext('2d');
		var imageObj = new Image();
		imageObj.onload = function() {
			context.globalAlpha=0.6;
			context.drawImage(imageObj, 0, 0);
		};
		imageObj.src = 'DB/Images/Chlorophyll/chrcolorbar.png';
	}
	function deleteChlorophyll(){
		layers.remove(imageLayerChlorophyll);
		imageLayerChlorophyll = null;
		
		//Clear colorbar
		var canvas = document.getElementById('cv');
		var context = canvas.getContext('2d');
		context.clearRect(0, 0, canvas.width, canvas.height);
	}
	function loadWaterTemperature(){
		if (imageLayerChlorophyll!=null)
			deleteChlorophyll();
		
		if (imageLayerWaterTemperature!=null)
			deleteWaterTemperature();
		
		//Loading select name
	    var nameSelect = document.getElementById('waterTemperature').value;
	
	    //Loading URL image
		imageLayerWaterTemperature = layers.addImageryProvider(new Cesium.SingleTileImageryProvider({
			url: 'DB/Images/WaterTemperature/' + nameSelect + '.png'
		}));
		imageLayerWaterTemperature.alpha = range.value;   
		
		//Show the colorbar
		var canvas = document.getElementById('cv');
		var context = canvas.getContext('2d');
		var imageObj = new Image();
		imageObj.onload = function() {
			context.globalAlpha=0.6;
			context.drawImage(imageObj, 0, 0);
		};
		imageObj.src = 'DB/Images/WaterTemperature/sst-colorbar.png';
		
	}
	function deleteWaterTemperature(){
	    layers.remove(imageLayerWaterTemperature);
		imageLayerWaterTemperature = null;
	  
		//Clear colorbar
		var canvas = document.getElementById('cv');
		var context = canvas.getContext('2d');
		context.clearRect(0, 0, canvas.width, canvas.height);
	}
	
	//--------------Animation--------------
	//Set Boat 
	var modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(Cesium.Cartesian3.fromDegrees(120, 21, 100.0));
	modelBoat = viewer.scene.primitives.add(Cesium.Model.fromGltf({
		url : 'DB/3DModel/3d-model.gltf',
		modelMatrix : modelMatrix,
		scale : 10000.0
	}));
		

/*
	var svg ='data:image/svg+xml,' +
           '<svg width="48px" height="48px" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg">';
	svg += '<circle cx="24" cy="24" r="10" style="fill:#ff141e;stroke-width:2px;stroke:#ececec;" />';
	svg += '</svg>';
	
	var svg ='data:image/svg+xml,' +
           '<svg width="48px" height="48px" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg">';
	svg += '<circle cx="24" cy="24" r="10" style="fill:#ff141e;stroke-width:2px;stroke:#ececec;" >';
	svg += '<set attributeName="24" to="50" begin="2s" repeatCount="indefinite">';
	svg += '</circle>';
	svg += '</svg>';

	console.log(svg);

	var image = new Image();
	image.src = svg;

	// create the cesium entity
	viewer.entities.add({
		position: Cesium.Cartesian3.fromDegrees(122, 20),
		billboard: {
		 image: image
		}
	});*/

	//Weather Station
	bluePin1 = viewer.entities.add({
	    name : 'DATN',
		description : '大潭',
		position : Cesium.Cartesian3.fromDegrees(121.050035, 25.029934),
		billboard : {
			image : pinBuilder.fromColor(Cesium.Color.ROYALBLUE, 48).toDataURL(),
			verticalOrigin : Cesium.VerticalOrigin.BOTTOM
		}
	});
	bluePin2 = viewer.entities.add({
		name : 'LIUK',
		description: '六塊厝',
		position : Cesium.Cartesian3.fromDegrees(121.448851, 25.242299),
		billboard : {
			image : pinBuilder.fromColor(Cesium.Color.ROYALBLUE, 48).toDataURL(),
			verticalOrigin : Cesium.VerticalOrigin.BOTTOM
		}
	});
	bluePin3 = viewer.entities.add({
		name : 'LUYE',
		description: '鹿野',
		position : Cesium.Cartesian3.fromDegrees(121.542213, 23.897390),
		billboard : {
			image : pinBuilder.fromColor(Cesium.Color.ROYALBLUE, 48).toDataURL(),
			verticalOrigin : Cesium.VerticalOrigin.BOTTOM
		}
	});
	bluePin4 = viewer.entities.add({
		name : 'NAWN',
		description: '南灣',
		position : Cesium.Cartesian3.fromDegrees(120.763424, 21.959325),
		billboard : {
			image : pinBuilder.fromColor(Cesium.Color.ROYALBLUE, 48).toDataURL(),
			verticalOrigin : Cesium.VerticalOrigin.BOTTOM
		}
	});

	screenSpaceEventHandler.setInputAction(function(movement) {
        var pickedObject = viewer.scene.pick(movement.position);
		console.log(pickedObject.id);
		if (Cesium.defined(pickedObject) && ((pickedObject.id == bluePin1) || (pickedObject.id == bluePin2)|| (pickedObject.id == bluePin3)|| (pickedObject.id == bluePin4)))
		{
			$("#dialog" ).dialog({
				  autoOpen: true,
				  width: 600,
				  height: 350,
				  modal: true
			});
			var weather = "Temperature";
			var date = "201612";
			posWeather = pickedObject.id.name;
			var pos = posWeather;

			console.log(pos);
			$.ajax({
				url: "DB/WeatherStation/getWeather.php",
				data:"weather="+ weather + "&date=" + date + "&pos=" + pos,
				type:"POST",
				dataType:"JSON",

				success: function(data){

					//Add Line
					var array = [];
					var len = data.length;
					
					//var cook = {"type": "LineString", "coordinates": [[120,22]] };
					for (i=0;i<len;i=i+1 ){
						//var c = [json[i].Latitude , json[i].Longitude];
						//cook.coordinates.push(c);
						array.push(parseFloat(data[i].key));	
					}
					setCharts(pos,array,weather);
				},

				error:   function(jqXHR, textStatus, errorThrown){ 
					alert("這個月沒有資料");
					console.log("error");
				}
			});
		}

		console.log(pickedObject.id._name);
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

	
	function loadPM25(){
		$.ajax({
			url: "http://opendata.epa.gov.tw/ws/Data/REWIQA/?$orderby=SiteName&$skip=0&$top=1000&format=json",
			dataType:"jsonp",
			success: function(data){	
				console.log(data.length);
				console.log(site.length);
				for(i=0;i<data.length;i++){
					var key = data[i].SiteName;
					for(j=0;j<site.length;j++){
						//Match Site
						if (key.match(site[j].SiteName)){
							var lon = site[j].TWD97Lon;
							var lat = site[j].TWD97Lat;
							var pm25 = data[i]["PM2.5"];
							//Set Color
							var pmColor = Cesium.Color.fromCssColorString('#9cff9c');
							if      ( 0<=pm25&&pm25<=11) pmColor = Cesium.Color.fromCssColorString('#9cff9c');
							else if (12<=pm25&&pm25<=23) pmColor = Cesium.Color.fromCssColorString('#31ff00');
							else if (24<=pm25&&pm25<=35) pmColor = Cesium.Color.fromCssColorString('#31cf00');
							else if (36<=pm25&&pm25<=41) pmColor = Cesium.Color.fromCssColorString('#ffff00');
							else if (42<=pm25&&pm25<=47) pmColor = Cesium.Color.fromCssColorString('#ffcf00');
							else if (48<=pm25&&pm25<=53) pmColor = Cesium.Color.fromCssColorString('#ff9a00');
							else if (54<=pm25&&pm25<=58) pmColor = Cesium.Color.fromCssColorString('#ff6464');
							else if (59<=pm25&&pm25<=64) pmColor = Cesium.Color.fromCssColorString('#ff0000');
							else if (65<=pm25&&pm25<=70) pmColor = Cesium.Color.fromCssColorString('#990000');
							else if (71<=pm25          ) pmColor = Cesium.Color.fromCssColorString('#ce30ff');
							//Add Billboard
							var surfacePosition = Cesium.Cartesian3.fromDegrees(lon, lat, 0);
							var heightPosition = Cesium.Cartesian3.fromDegrees(lon, lat, pm25 * 1000);
							var polyline = new Cesium.PolylineGraphics();
							polyline.material = new Cesium.ColorMaterialProperty(pmColor);
							polyline.width = new Cesium.ConstantProperty(10);
							polyline.followSurface = new Cesium.ConstantProperty(false);
							polyline.positions = new Cesium.ConstantProperty([surfacePosition, heightPosition]);
							
							if (0<=pm25 && pm25<=120){
								var entity = viewer.entities.add({
									name : site[j].SiteName,						
									description:  "<div style='background-color:#a0a0a0; padding:0px;'><table>"
												  +"<tr><td>County</td><td>" + data[i].County + "</td></tr>"
												  +"<tr><td>PM2.5</td><td>" + data[i]["PM2.5"] + "</td></tr>"
												  +"<tr><td>PublishTime</td><td>" + data[i]["PublishTime"] + "</td></tr>"
												  +"</table></div>",
									position: Cesium.Cartesian3.fromDegrees(lon, lat,  pm25 * 500),  //the Height must be half of length
									cylinder : {
										length : pm25 * 1000,
										topRadius : 2000.0,
										bottomRadius : 2000.0,
										material : pmColor
									}
									//position : Cesium.Cartesian3.fromDegrees(lon, lat),
									//billboard : {
									//	image : pinBuilder.fromColor(pmColor, 48).toDataURL(),
									//	verticalOrigin : Cesium.VerticalOrigin.BOTTOM
									//}
									
								});
								entityPM25.push(entity);
							}
						}
					}
				}
				viewer.flyTo(viewer.entities);
			},
			
			error: function(data){
				alert("error");
			}
		});
	}
	
	function deletePM25() {	
		if (entityPM25.length == 0)
			return;
			
	    for(var i=0;i<entityPM25.length;i++){
			viewer.entities.remove(entityPM25[i]);
		}
			
		entityPM25 = [];
	}
	
</script>
</body>
</html>
